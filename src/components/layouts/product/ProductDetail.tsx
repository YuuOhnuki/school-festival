'use client';

import { useState } from 'react';
import { Product, Shop } from '@/types';
import Image from 'next/image';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { BackButton } from '@/components/BackButton';
import ProductCard from './ProductCard';

interface ProductDetailProps {
    product: Product;
    shops: Shop[];
    products: Product[];
}

// Related Products Component
const RelatedProducts = ({
    currentProductId,
    shopId,
    products,
}: {
    currentProductId: number;
    shopId: number;
    products: Product[];
}) => {
    const relatedProducts = products
        .filter((product) => product.shopId === shopId && product.id !== currentProductId)
        .slice(0, 3);

    if (relatedProducts.length === 0) {
        return <div className="text-center py-8 text-neutral-500">Âêå„Åò„ÅäÂ∫ó„ÅÆ‰ªñ„ÅÆÂïÜÂìÅ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>;
    }

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {relatedProducts.map((product) => (
                <ProductCard key={product.id} product={product} />
            ))}
        </div>
    );
};

const ProductDetail = ({ product, shops, products }: ProductDetailProps) => {
    const [selectedImageIndex, setSelectedImageIndex] = useState(0);
    const [imageError, setImageError] = useState(false);
    const shop = shops.find((p) => p.id === product.shopId);

    // „Ç¢„É¨„É´„ÇÆ„ÉºÊÉÖÂ†±„ÅÆÈÖçÂàó
    const allergens = [
        { key: 'hasEbi', label: '„Åà„Å≥', icon: 'ü¶ê' },
        { key: 'hasKani', label: '„Åã„Å´', icon: 'ü¶Ä' },
        { key: 'hasKurumi', label: '„Åè„Çã„Åø', icon: 'ü•ú' },
        { key: 'hasKomugi', label: 'Â∞èÈ∫¶', icon: 'üåæ' },
        { key: 'hasSoba', label: '„Åù„Å∞', icon: 'üçú' },
        { key: 'hasTamago', label: 'Âçµ', icon: 'ü•ö' },
        { key: 'hasMilk', label: '‰π≥', icon: 'ü•õ' },
        { key: 'hasRakkasei', label: 'ËêΩËä±Áîü', icon: 'ü•ú' },
    ];

    const presentAllergens = allergens.filter((allergen) => product[allergen.key as keyof Product] === true);

    const images = product.images.length > 0 ? product.images : [product.thumbnail].filter(Boolean);

    const handleImageError = () => {
        setImageError(true);
    };

    return (
        <div>
            <BackButton />

            <div className="grid lg:grid-cols-2 gap-4">
                {product.isSoldOut && (
                    <Alert variant="destructive" className="lg:col-span-2 col-span-1 bg-red-50">
                        <AlertTitle className="font-bold text-xl">Â£≤„ÇäÂàá„Çå‰∏≠</AlertTitle>
                        <AlertDescription>„Åì„ÅÆÂïÜÂìÅ„ÅØÁèæÂú®Â£≤„ÇäÂàá„Çå‰∏≠„Åß„Åô„ÄÇ</AlertDescription>
                    </Alert>
                )}
                {/* ÂïÜÂìÅÁîªÂÉè */}
                <div className="space-y-4">
                    <div className="aspect-square bg-neutral-100 dark:bg-neutral-800 rounded-2xl overflow-hidden">
                        <Image
                            width="600"
                            height="600"
                            src={
                                imageError || !images[selectedImageIndex]
                                    ? '/images/placeholder.png'
                                    : images[selectedImageIndex]
                            }
                            alt={product.name}
                            className="w-full h-full object-cover hover:scale-105 transition-transform duration-500"
                            onError={handleImageError}
                        />
                    </div>

                    {/* „Çµ„É†„Éç„Ç§„É´ */}
                    {images.length > 1 && (
                        <div className="flex gap-2 overflow-x-auto">
                            {images.map((image, index) => (
                                <button
                                    key={index}
                                    onClick={() => setSelectedImageIndex(index)}
                                    className={`flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition-colors ${
                                        selectedImageIndex === index
                                            ? 'border-blue-500'
                                            : 'border-neutral-200 dark:border-neutral-700'
                                    }`}
                                >
                                    <Image
                                        width={1000}
                                        height={1000}
                                        src={imageError || !image ? '/images/placeholder.png' : image}
                                        alt={`${product.name} ${index + 1}`}
                                        className="w-full h-full object-cover"
                                        onError={handleImageError}
                                    />
                                </button>
                            ))}
                        </div>
                    )}
                </div>

                {/* ÂïÜÂìÅÊÉÖÂ†± */}
                <div className="space-y-6">
                    <div>
                        <div className="flex items-center gap-3 mb-2">
                            <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                3{shop?.className}
                            </span>
                        </div>
                        <h1 className="text-3xl md:text-4xl font-bold text-neutral-800 dark:text-neutral-200 mb-4">
                            {product.name}
                        </h1>
                        <p className="text-lg text-neutral-600 dark:text-neutral-400 leading-relaxed">
                            {product.description}
                        </p>
                    </div>

                    {/* ‰æ°Ê†º„Å®Ë≤©Â£≤Êï∞ */}
                    <div className="bg-neutral-50 dark:bg-neutral-800 rounded-xl p-6">
                        <div className="flex items-center justify-between mb-4">
                            <span className="text-3xl font-bold text-blue-600">¬•{product.price}</span>
                            <span className="text-neutral-500">Â£≤‰∏ä: {product.sales}ÂÄã</span>
                        </div>
                        <div className="text-sm text-neutral-600 dark:text-neutral-400">
                            {shop && (
                                <p>
                                    Êèê‰æõÂ∫óËàó: <span className="font-medium">{shop.name}</span>
                                </p>
                            )}
                        </div>
                    </div>

                    {/* Ê†ÑÈ§äÊàêÂàÜË°®Á§∫ */}
                    {(product.calories !== null || product.protein !== null) && (
                        <div className="bg-green-50 dark:bg-green-900/20 rounded-xl p-6">
                            <h3 className="text-lg font-bold text-green-800 dark:text-green-300 mb-4 flex items-center gap-2">
                                <span>üçé</span>
                                Ê†ÑÈ§äÊàêÂàÜË°®Á§∫Ôºà1È£ü„ÅÇ„Åü„ÇäÔºâ
                            </h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {product.calories !== null && (
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-green-700 dark:text-green-400">
                                            {product.calories}
                                        </div>
                                        <div className="text-sm text-neutral-600 dark:text-neutral-400">
                                            „Ç´„É≠„É™„Éº
                                            <br />
                                            (kcal)
                                        </div>
                                    </div>
                                )}
                                {product.protein !== null && (
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-green-700 dark:text-green-400">
                                            {product.protein}
                                        </div>
                                        <div className="text-sm text-neutral-600 dark:text-neutral-400">
                                            „Åü„Çì„Å±„ÅèË≥™
                                            <br />
                                            (g)
                                        </div>
                                    </div>
                                )}
                                {product.fat !== null && (
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-green-700 dark:text-green-400">
                                            {product.fat}
                                        </div>
                                        <div className="text-sm text-neutral-600 dark:text-neutral-400">
                                            ËÑÇË≥™
                                            <br />
                                            (g)
                                        </div>
                                    </div>
                                )}
                                {product.carbohydrate !== null && (
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-green-700 dark:text-green-400">
                                            {product.carbohydrate}
                                        </div>
                                        <div className="text-sm text-neutral-600 dark:text-neutral-400">
                                            ÁÇ≠Ê∞¥ÂåñÁâ©
                                            <br />
                                            (g)
                                        </div>
                                    </div>
                                )}
                                {product.sodium !== null && (
                                    <div className="text-center col-span-2 md:col-span-4">
                                        <div className="text-2xl font-bold text-green-700 dark:text-green-400">
                                            {product.sodium}
                                        </div>
                                        <div className="text-sm text-neutral-600 dark:text-neutral-400">
                                            È£üÂ°©Áõ∏ÂΩìÈáè (mg)
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* „Ç¢„É¨„É´„ÇÆ„ÉºÊÉÖÂ†± */}
                    <div className="bg-yellow-50 dark:bg-yellow-900/20 rounded-xl p-6">
                        <h3 className="text-lg font-bold text-yellow-800 dark:text-yellow-300 mb-4 flex items-center gap-2">
                            <span>‚ö†Ô∏è</span>
                            „Ç¢„É¨„É´„ÇÆ„ÉºÊÉÖÂ†±
                        </h3>
                        {presentAllergens.length > 0 ? (
                            <div>
                                <p className="text-sm text-yellow-700 dark:text-yellow-400 mb-3">
                                    „Åì„ÅÆÂïÜÂìÅ„Å´„ÅØ‰ª•‰∏ã„ÅÆ„Ç¢„É¨„É´„Ç≤„É≥„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„ÅôÔºö
                                </p>
                                <div className="flex flex-wrap gap-2">
                                    {presentAllergens.map((allergen) => (
                                        <div
                                            key={allergen.key}
                                            className="bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2"
                                        >
                                            <span>{allergen.icon}</span>
                                            {allergen.label}
                                        </div>
                                    ))}
                                </div>
                                <p className="text-xs text-yellow-600 dark:text-yellow-500 mt-3">
                                    „Ç¢„É¨„É´„ÇÆ„Éº„Çí„ÅäÊåÅ„Å°„ÅÆÊñπ„ÅØÂçÅÂàÜ„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑ„ÄÇ
                                </p>
                            </div>
                        ) : (
                            <div className="px-2 rounded-lg">
                                <div className="flex items-center gap-2">
                                    <span>‚úÖ</span>
                                    <span className="font-bold">‰∏ªË¶Å„Ç¢„É¨„É´„Ç≤„É≥‰∏ç‰ΩøÁî®</span>
                                </div>
                                <p className="text-sm mt-1">„Åì„ÅÆÂïÜÂìÅ„Å´„ÅØ‰∏ªË¶Å8ÂìÅÁõÆ„ÅÆ„Ç¢„É¨„É´„Ç≤„É≥„ÅØÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
                            </div>
                        )}
                    </div>

                    {/* Â∫óËàóÊÉÖÂ†± */}
                    {shop && (
                        <div className="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6">
                            <h3 className="text-lg font-bold text-blue-800 dark:text-blue-300 mb-4 flex items-center gap-2">
                                <span>üè™</span>
                                Â∫óËàóÊÉÖÂ†±
                            </h3>
                            <div className="space-y-3">
                                <div>
                                    <h4 className="font-bold text-blue-700 dark:text-blue-400">{shop.name}</h4>
                                    <p className="text-sm text-neutral-600 dark:text-neutral-400 mt-1">
                                        {shop.description}
                                    </p>
                                </div>
                                <div className="flex items-center gap-4 text-sm text-neutral-600 dark:text-neutral-400">
                                    <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded font-medium">
                                        3Âπ¥{shop.className}ÁµÑ
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Ê≥®ÊÑè‰∫ãÈ†Ö */}
                    <div className="bg-neutral-100 dark:bg-neutral-800 rounded-xl p-6">
                        <h3 className="text-lg font-bold text-neutral-800 dark:text-neutral-300 mb-3 flex items-center gap-2">
                            <span>üìã</span>
                            „ÅîÊ≥®ÊÑè‰∫ãÈ†Ö
                        </h3>
                        <ul className="space-y-2 text-sm text-neutral-600 dark:text-neutral-400">
                            <li className="flex items-start gap-2">
                                <span className="text-blue-500 mt-1">‚Ä¢</span>
                                Êï∞Èáè„Å´Èôê„Çä„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂ£≤„ÇäÂàá„Çå„ÅÆÈöõ„ÅØ„Åî‰∫ÜÊâø„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="text-blue-500 mt-1">‚Ä¢</span>
                                „Ç¢„É¨„É´„ÇÆ„ÉºÊÉÖÂ†±„ÅØË™øÁêÜÊôÇ„ÅÆÊ∑∑ÂÖ•„ÇÇÂê´„ÇÅ„Å¶Ë°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="text-blue-500 mt-1">‚Ä¢</span>
                                Ê†ÑÈ§äÊàêÂàÜ„ÅØË®àÁÆóÂÄ§„ÅÆ„Åü„ÇÅ„ÄÅÂÆüÈöõ„ÅÆÂÄ§„Å®Â§öÂ∞ëÁï∞„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="text-blue-500 mt-1">‚Ä¢</span>
                                ÂïÜÂìÅ„ÅÆË¶ã„ÅüÁõÆ„ÅØÂÜôÁúü„Å®Áï∞„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            {/* Èñ¢ÈÄ£ÂïÜÂìÅ */}
            <div className="mt-16">
                <h2 className="text-2xl md:text-3xl font-bold mb-8 text-neutral-800 dark:text-neutral-200">
                    Âêå„Åò„ÅäÂ∫ó„ÅÆ‰ªñ„ÅÆÂïÜÂìÅ
                </h2>
                <RelatedProducts currentProductId={product.id} shopId={product.shopId} products={products} />
            </div>
        </div>
    );
};

export default ProductDetail;
